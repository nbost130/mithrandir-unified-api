<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéôÔ∏è Transcription Projects - Mithrandir</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #1d1d1f;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .nav-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            text-decoration: none;
            display: inline-block;
        }
        
        .btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
            transform: translateY(-2px);
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 15px;
        }
        
        .btn-retry {
            background: rgba(255,149,0,0.2);
            border-color: rgba(255,149,0,0.5);
        }
        
        .btn-retry:hover {
            background: rgba(255,149,0,0.3);
        }
        
        .project-card {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            overflow: hidden;
        }
        
        .project-header {
            padding: 25px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .project-header:hover {
            background: rgba(0,0,0,0.02);
        }
        
        .project-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #1d1d1f;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .project-stats {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
        }
        
        .stat {
            padding: 6px 12px;
            border-radius: 12px;
            font-weight: 600;
        }
        
        .stat-completed { background: #d1f2eb; color: #00875a; }
        .stat-processing { background: #fff4e6; color: #ff8b00; }
        .stat-pending { background: #e3f2fd; color: #0052cc; }
        .stat-failed { background: #ffebee; color: #d32f2f; }
        
        .project-files {
            display: none;
            padding: 0 25px 25px;
        }
        
        .project-files.expanded {
            display: block;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .file-item:last-child {
            border-bottom: none;
        }
        
        .file-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .file-status-icon {
            font-size: 1.2rem;
        }
        
        .file-name {
            font-weight: 500;
            color: #1d1d1f;
        }
        
        .file-meta {
            font-size: 0.8rem;
            color: #86868b;
            margin-left: 30px;
        }
        
        .file-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #007aff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error-message {
            background: rgba(255,59,48,0.1);
            color: #d32f2f;
            padding: 15px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
            border: 1px solid rgba(255,59,48,0.2);
        }
        
        .expand-icon {
            transition: transform 0.3s ease;
        }
        
        .expand-icon.expanded {
            transform: rotate(90deg);
        }
        
        @media (max-width: 768px) {
            .project-stats {
                flex-direction: column;
                gap: 8px;
            }
            
            .file-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .file-actions {
                align-self: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéôÔ∏è Transcription Projects</h1>
            <p>Manage your transcription files by project</p>
        </div>

        <div class="nav-controls">
            <a href="/public/api-dashboard.html" class="btn">‚Üê Back to Dashboard</a>
            <div>
                <button class="btn" id="refreshBtn">üîÑ Refresh</button>
                <button class="btn" id="autoRefreshBtn">‚è±Ô∏è Auto-Refresh: ON</button>
            </div>
        </div>

        <div id="projectsContainer">
            <div style="text-align: center; padding: 50px; color: white;">
                <div class="loading"></div>
                <p style="margin-top: 15px;">Loading projects...</p>
            </div>
        </div>
    </div>

    <script>
        let autoRefresh = true;
        let refreshInterval;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadProjects();
            startAutoRefresh();

            // Add event listeners
            document.getElementById('refreshBtn').addEventListener('click', refreshProjects);
            document.getElementById('autoRefreshBtn').addEventListener('click', toggleAutoRefresh);
        });

        // Transform job data to project format
        function transformJobsToProjects(jobs) {
            if (!jobs || jobs.length === 0) {
                return [];
            }
            
            const projectMap = {};
            
            jobs.forEach(job => {
                const fileName = job.fileName || "Unknown";
                const projectName = "Transcription Files";
                
                if (!projectMap[projectName]) {
                    projectMap[projectName] = {
                        name: projectName,
                        completed: 0,
                        processing: 0,
                        pending: 0,
                        failed: 0,
                        files: []
                    };
                }
                
                const project = projectMap[projectName];
                
                if (job.status === "completed") {
                    project.completed++;
                } else if (job.status === "processing") {
                    project.processing++;
                } else if (job.status === "failed") {
                    project.failed++;
                } else {
                    project.pending++;
                }
                
                project.files.push({
                    id: job.jobId,
                    name: fileName,
                    status: job.status,
                    progress: job.progress || 0,
                    startTime: job.startedAt,
                    endTime: job.completedAt,
                    error: job.error || null
                });
            });
            
            return Object.values(projectMap);
        }


        async function loadProjects() {
            // Simple API test
            console.log("Testing API connection...");
            try {
                const testResponse = await fetch("http://100.77.230.53:9999/api/v1/health");
                const testData = await testResponse.json();
                console.log("API Health Check:", testData);
            } catch (error) {
                console.error("API Health Check Failed:", error);
                showError("Cannot connect to transcription service. Please check if the service is running.");
                return;
            }
            try {
                // Fetch jobs from all status endpoints
                const [pendingRes, processingRes, completedRes, failedRes] = await Promise.all([
                    fetch("http://100.77.230.53:9999/api/v1/jobs?_t=" + Date.now() + "http://100.77.230.53:9999/api/v1/jobs?status=status=pending&limit=50"),
                    fetch("http://100.77.230.53:9999/api/v1/jobs?_t=" + Date.now() + "http://100.77.230.53:9999/api/v1/jobs?status=status=processing&limit=50"),
                    fetch("http://100.77.230.53:9999/api/v1/jobs?_t=" + Date.now() + "http://100.77.230.53:9999/api/v1/jobs?status=status=completed&limit=50"),
                    fetch("http://100.77.230.53:9999/api/v1/jobs?_t=" + Date.now() + "http://100.77.230.53:9999/api/v1/jobs?status=status=failed&limit=50")
                ]);

                const [pendingData, processingData, completedData, failedData] = await Promise.all([
                    pendingRes.json(),
                    processingRes.json(),
                    completedRes.json(),
                    failedRes.json()
                ]);

                // Combine all jobs
                const allJobs = [
                    ...(pendingData.data || []),
                    ...(processingData.data || []),
                    ...(completedData.data || []),
                    ...(failedData.data || [])
                ];

                console.log("Loaded jobs:", allJobs.length);
                console.log("Sample job data:", allJobs[0]);
                console.log("API responses:", {pending: pendingData, processing: processingData, completed: completedData, failed: failedData});

                // Transform job data to project format
                const projects = transformJobsToProjects(allJobs);

                if (projects && projects.length > 0) {
                    renderProjects(projects);
                } else {
                    showError("No transcription projects found");
                }
            } catch (error) {
                showError("Failed to load projects: " + error.message);
            }
        }

        function renderProjects(projects) {
            const container = document.getElementById('projectsContainer');

            if (projects.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 50px; color: white;"><p>No transcription projects found.</p></div>';
                return;
            }

            container.innerHTML = projects.map(project =>
                '<div class="project-card">' +
                    '<div class="project-header" onclick="toggleProject(\'' + project.name + '\')">' +
                        '<div class="project-title">' +
                            '<span class="expand-icon" id="icon-' + project.name + '">‚ñ∂</span>' +
                            'üìÅ ' + project.name +
                        '</div>' +
                        '<div class="project-stats">' +
                            '<span class="stat stat-completed">' + project.completed + ' completed</span>' +
                            '<span class="stat stat-processing">' + project.processing + ' processing</span>' +
                            '<span class="stat stat-pending">' + project.pending + ' pending</span>' +
                            (project.failed > 0 ? '<span class="stat stat-failed">' + project.failed + ' failed</span>' : '') +
                        '</div>' +
                    '</div>' +
                    '<div class="project-files" id="files-' + project.name + '">' +
                        project.files.map(file => renderFile(file)).join('') +
                    '</div>' +
                '</div>'
            ).join('');
        }

        function renderFile(file) {
            const statusIcons = {
                completed: '‚úÖ',
                processing: 'üîÑ',
                pending: '‚è≥',
                failed: '‚ùå'
            };

            const formatDate = (dateStr) => {
                if (!dateStr) return '';
                return new Date(dateStr).toLocaleString();
            };

            const formatFileSize = (bytes) => {
                if (!bytes) return '';
                const mb = bytes / (1024 * 1024);
                return mb.toFixed(1) + ' MB';
            };

            return '<div class="file-item">' +
                    '<div class="file-info">' +
                        '<span class="file-status-icon">' + statusIcons[file.status] + '</span>' +
                        '<div>' +
                            '<div class="file-name">' + file.fileName + '</div>' +
                            '<div class="file-meta">' +
                                formatFileSize(file.fileSize) + ' ‚Ä¢ ' +
                                'Created: ' + formatDate(file.createdAt) +
                                (file.completedAt ? ' ‚Ä¢ Completed: ' + formatDate(file.completedAt) : '') +
                                (file.error ? ' ‚Ä¢ Error: ' + file.error : '') +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                    '<div class="file-actions">' +
                        (file.status === 'failed' ?
                            '<button class="btn btn-small btn-retry" onclick="retryJob(\'' + file.id + '\')">üîÑ Retry</button>' :
                            ''
                        ) +
                        (file.status === 'completed' && file.outputPath ?
                            '<button class="btn btn-small" onclick="downloadTranscript(\'' + file.id + '\')">üìÑ Download</button>' :
                            ''
                        ) +
                    '</div>' +
                '</div>';
        }

        function toggleProject(projectName) {
            const filesDiv = document.getElementById('files-' + projectName);
            const icon = document.getElementById('icon-' + projectName);

            if (filesDiv.classList.contains('expanded')) {
                filesDiv.classList.remove('expanded');
                icon.classList.remove('expanded');
            } else {
                filesDiv.classList.add('expanded');
                icon.classList.add('expanded');
            }
        }

        async function retryJob(jobId) {
            try {
                // Our API uses POST to /api/v1/jobs/{id}/retry
                const response = await fetch("http://100.77.230.53:9999/api/v1/jobs/" + jobId + "/retry", {
                    method: "POST"
                });
                const result = await response.json();

                if (result.success) {
                    loadProjects();
                    showSuccess("Job queued for retry successfully!");
                } else {
                    showError("Failed to retry job: " + (result.error || "Unknown error"));
                }
            } catch (error) {
                showError("Failed to retry job: " + error.message);
            }
        }

        function downloadTranscript(jobId) {
            showError('Download functionality not yet implemented');
        }

        function refreshProjects() {
            loadProjects();
        }

        function toggleAutoRefresh() {
            autoRefresh = !autoRefresh;
            const btn = document.getElementById('autoRefreshBtn');
            btn.textContent = '‚è±Ô∏è Auto-Refresh: ' + (autoRefresh ? 'ON' : 'OFF');

            if (autoRefresh) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        }

        function startAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(loadProjects, 30000);
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        function showError(message) {
            const container = document.getElementById('projectsContainer');
            container.innerHTML = '<div class="error-message">' + message + '</div>' + container.innerHTML;
            setTimeout(function() {
                const errorDiv = container.querySelector('.error-message');
                if (errorDiv) errorDiv.remove();
            }, 5000);
        }

        function showSuccess(message) {
            const container = document.getElementById('projectsContainer');
            container.innerHTML = '<div style="background: rgba(52,199,89,0.1); color: #2e7d32; padding: 15px; border-radius: 12px; margin: 20px 0; text-align: center; border: 1px solid rgba(52,199,89,0.2);">' + message + '</div>' + container.innerHTML;
            setTimeout(function() {
                const successDiv = container.querySelector('div[style*="rgba(52,199,89"]');
                if (successDiv) successDiv.remove();
            }, 3000);
        }
    </script>



</body>
</html>
